<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment - Roblox Store</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 700px; margin: auto; }
.card { background: #fff; border-radius: 20px; padding: 32px; }
h2 { text-align: center; margin-bottom: 12px; }

.payment-info {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: #fff;
  border-radius: 14px;
  padding: 20px;
  text-align: center;
  margin-bottom: 24px;
}
.payment-info .amount { font-size: 40px; font-weight: 900; }

.section { margin-bottom: 24px; }
label { font-weight: 600; display: block; margin-bottom: 6px; }

input[type="text"] {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 2px solid #ddd;
  font-size: 16px;
}
input:focus { outline: none; border-color: #667eea; }

.qris { text-align: center; }
.qris img {
  max-width: 280px;
  border-radius: 12px;
  border: 3px solid #667eea;
}

.upload-box {
  border: 2px dashed #667eea;
  padding: 24px;
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
}
.upload-box.done { border-color: #28a745; background: #e9f8ee; }
.preview { max-width: 100%; margin-top: 12px; border-radius: 10px; }

.actions { display: flex; gap: 12px; }
.actions a, .actions button {
  flex: 1;
  padding: 16px;
  border-radius: 12px;
  border: none;
  font-weight: 800;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
}
.back { background: #6c757d; color: #fff; }
.send { background: linear-gradient(135deg,#43e97b,#38f9d7); color: #fff; }
.send:disabled { opacity: .6; cursor: not-allowed; }
</style>
</head>

<body>
<div class="container">
  <div class="card">

    <h2>üí≥ Pembayaran Robux</h2>

    <div class="payment-info">
      <div>Anda membeli</div>
      <div class="amount">üíé <span id="amountText">-</span></div>
      <div>Total: <span id="priceText">-</span></div>
      <div id="deliveryText"></div>
    </div>

    <div class="section">
      <label>üë§ Username Roblox</label>
      <input type="text" id="username" placeholder="Masukkan username Roblox">
    </div>

    <div class="section qris">
      <h3>üì± Scan QRIS</h3>
      <img src="/Qris.jpeg" alt="QRIS">
      <p>Scan menggunakan aplikasi pembayaran</p>
    </div>

    <div class="section">
      <label>üì∏ Upload Bukti Transfer</label>
      <div class="upload-box" id="uploadBox">
        Klik untuk upload bukti
        <input type="file" id="fileInput" accept="image/*" hidden>
        <img id="preview" class="preview" style="display:none">
      </div>
    </div>

    <div class="actions">
      <a href="index.html" class="back">Kembali</a>
      <button class="send" id="sendBtn">Kirim Pesanan</button>
    </div>

  </div>
</div>

<script>
/* ===============================
   DISCORD WEBHOOK (ANTI HAPUS)
================================ */
const DISCORD_WEBHOOK_URL =
  "https://discord.com/api/webhooks/1451905582117425215/2ZkLzr6avvdxXx-kd8gMNbJ2F11VyADWFji9gx-TAf6pOm5zCfth1wslEigh6S1ttBWE";

/* ===============================
   PARAMETER URL
================================ */
const params = new URLSearchParams(location.search);
const amount = Number(params.get("amount"));
const price = params.get("price");
const deliveryType = params.get("delivery");
const poInfo = params.get("poInfo") || "";

/* ===============================
   TAMPILKAN KE UI (FIX FINAL)
================================ */
amountText.textContent = amount ? amount.toLocaleString("id-ID") : "-";
priceText.textContent = price || "-";
deliveryText.textContent = deliveryType ? deliveryType.replace(/\+/g, " ") : "";

/* ===============================
   STATE UPLOAD
================================ */
let proofBlob = null;

uploadBox.onclick = () => fileInput.click();

fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file) return;

  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";
  uploadBox.classList.add("done");
  proofBlob = file;
};

/* ===============================
   SEND DISCORD (FILE ATTACHMENT)
================================ */
async function sendToDiscord(payload) {
  const embed = {
    title: "üßæ Pesanan Robux Baru",
    color: 5763719,
    fields: [
      { name: "Order ID", value: payload.orderId },
      { name: "Username", value: payload.username, inline: true },
      { name: "Robux", value: payload.amount.toLocaleString("id-ID"), inline: true },
      { name: "Total", value: payload.price },
      { name: "Delivery", value: payload.deliveryType || "-" },
      { name: "PO Info", value: payload.poInfo || "-" }
    ],
    footer: { text: "R STORE - ROBUX" },
    timestamp: new Date()
  };

  const fd = new FormData();
  fd.append("payload_json", JSON.stringify({
    content: "üîî Pesanan Robux baru masuk",
    embeds: [embed]
  }));
  fd.append("file", proofBlob, "bukti_transfer.jpg");

  await fetch(DISCORD_WEBHOOK_URL, { method: "POST", body: fd });
}

/* ===============================
   SUBMIT FINAL
================================ */
sendBtn.onclick = async () => {
  const username = document.getElementById("username").value.trim();
  if (!username) return alert("Username Roblox wajib diisi");
  if (!proofBlob) return alert("Upload bukti transfer");

  sendBtn.disabled = true;

  const orderId = "RBX-" + Date.now();
  const payload = {
    orderId,
    username,
    amount,
    price,
    deliveryType,
    poInfo,
    status: "pending",
    createdAt: new Date().toISOString()
  };

  try {
    // 1Ô∏è‚É£ FIRESTORE (Vercel API)
    await fetch("/api/order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // 2Ô∏è‚É£ DISCORD (ANTI HAPUS)
    await sendToDiscord(payload);

    // 3Ô∏è‚É£ SUCCESS
    location.href = "process.html?orderId=" + orderId;
  } catch (e) {
    alert("Gagal mengirim pesanan");
    sendBtn.disabled = false;
  }
};
</script>
</body>
</html>
